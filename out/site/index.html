<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Photo Archive</title>
<style>
  *{box-sizing:border-box}
  :root {
    --gap:16px; --border:#ddd; --muted:#666; --bg:#fff; --bg2:#fafafa;
    --shadow:0 8px 24px rgba(0,0,0,.12);
    --card-min: 260px; /* zoomable grid cell */
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:24px;background:var(--bg2)}
  header.toolbar{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
  input,select,button{padding:6px 8px}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--card-min),1fr));gap:var(--gap)}
  .cards.cards--list{display:flex;flex-direction:column}
  .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--bg)}
  .muted{color:var(--muted);font-size:12px}
  .row{margin:6px 0}
  a{word-break:break-all}
  .pill{display:inline-block;border:1px solid #ccc;border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px}
  .list-row{display:flex;gap:12px;align-items:flex-start}
  .thumb{max-width:100%;border-radius:8px;margin-bottom:8px}
  .list-row .thumb{max-width:160px}
  .group{display:flex;gap:8px;align-items:center}
  .ms{position:relative}
  .ms__button{display:flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--bg);
              border-radius:10px;padding:6px 10px;cursor:pointer}
  .ms__button-badge{background:#eee;border-radius:999px;padding:2px 8px;font-size:12px}
  .ms__popover{position:absolute;top:calc(100% + 8px);left:0;z-index:20;width:280px;background:var(--bg);
               border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px}
  .ms__popover[hidden]{display:none}
  .ms__search{width:100%;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
  .ms__list{margin-top:8px;max-height:220px;overflow:auto;border:1px solid var(--border);
            border-radius:10px;padding:6px}
  .ms__item{display:flex;align-items:center;gap:8px;padding:4px 2px}
  .ms__actions{display:flex;gap:8px;margin-top:8px}
  .ms__chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .chip{display:flex;align-items:center;gap:6px;background:#f0f0f0;border-radius:999px;padding:2px 8px;font-size:12px}
  .chip button{border:none;background:transparent;cursor:pointer;padding:0 2px;font-size:14px;line-height:1}
</style>
</head>
<body>
<header class="toolbar">
  <h1 style="margin:0">Photo Archive</h1>

  <!-- Film multi-select -->
  <div class="ms" id="filmMs">
    <button type="button" class="ms__button" id="filmMsBtn" aria-haspopup="listbox" aria-expanded="false">
      <span>Pick films</span>
      <span class="ms__button-badge" id="filmMsCount">All</span>
    </button>
    <div class="ms__popover" id="filmMsPop" hidden>
      <input id="filmMsSearch" class="ms__search" placeholder="Search films…" />
      <div class="ms__actions">
        <button id="filmMsSelectAll" type="button">Select all (filtered)</button>
        <button id="filmMsClear" type="button">Clear</button>
      </div>
      <div id="filmMsList" class="ms__list" role="listbox" aria-multiselectable="true"></div>
      <div class="ms__chips" id="filmMsChips"></div>
    </div>
  </div>

  <!-- Sleeves multi-select -->
  <div class="ms" id="sleevesMs">
    <button type="button" class="ms__button" id="msBtn" aria-haspopup="listbox" aria-expanded="false">
      <span>Pick sleeves</span>
      <span class="ms__button-badge" id="msCount">All</span>
    </button>
    <div class="ms__popover" id="msPop" hidden>
      <input id="msSearch" class="ms__search" placeholder="Search sleeves…" />
      <div class="ms__actions">
        <button id="msSelectAll" type="button">Select all (filtered)</button>
        <button id="msClear" type="button">Clear</button>
      </div>
      <div id="msList" class="ms__list" role="listbox" aria-multiselectable="true"></div>
      <div class="ms__chips" id="msChips"></div>
    </div>
  </div>

  <div class="group">
    <label for="viewMode">View</label>
    <select id="viewMode">
      <option value="grid" selected>Grid</option>
      <option value="list">List</option>
    </select>
  </div>

  <div class="group">
    <label for="sortKey">Sort</label>
    <select id="sortKey">
      <option value="print_id">PrintID (A→Z)</option>
      <option value="film">Film (A→Z)</option>
      <option value="title">Title (A→Z)</option>
      <option value="negative_sleeve">Sleeve (A→Z)</option>
    </select>
  </div>

  <div class="group" style="align-items:center">
    <label for="zoom">Zoom</label>
    <input id="zoom" type="range" min="180" max="520" step="20" value="260" />
  </div>

  <button id="toggleThumbs">Hide thumbnails</button>
</header>

<div id="cards" class="cards"></div>

<script>
(async function(){
  const res = await fetch('catalog.json?ts=' + Date.now());
  const items = await res.json();
  const $ = s => document.querySelector(s);
  const cards = $('#cards');
  const viewMode = $('#viewMode');
  const sortKey = $('#sortKey');
  const toggleThumbsBtn = $('#toggleThumbs');
  const zoom = $('#zoom');

  const norm = v => (v ?? '').toString().toLowerCase();
  const naturalSort = (a,b)=> String(a).localeCompare(String(b), undefined, {numeric:true, sensitivity:'base'});

  // ----- Film multi-select -----
  const filmMs = $('#filmMs');
  const filmMsBtn = $('#filmMsBtn');
  const filmMsPop = $('#filmMsPop');
  const filmMsSearch = $('#filmMsSearch');
  const filmMsList = $('#filmMsList');
  const filmMsCount = $('#filmMsCount');
  const filmMsChips = $('#filmMsChips');
  const filmMsSelectAll = $('#filmMsSelectAll');
  const filmMsClear = $('#filmMsClear');

  const allFilms = Array.from(new Set(items.map(i=>i.film).filter(Boolean))).sort(naturalSort);
  const selectedFilms = new Set();
  let filteredFilms = allFilms.slice();

  function updateFilmCount(){
    if (selectedFilms.size === 0){ filmMsCount.textContent = 'All'; return; }
    const first = Array.from(selectedFilms).sort(naturalSort).slice(0,2).join(', ');
    filmMsCount.textContent = selectedFilms.size > 2 ? `${first} +${selectedFilms.size-2}` : first || 'All';
  }
  function renderFilmList(){
    filmMsList.innerHTML='';
    for (const f of filteredFilms){
      const id = 'film_' + btoa(unescape(encodeURIComponent(f))).replace(/=/g,'');
      const row = document.createElement('label');
      row.className='ms__item';
      row.setAttribute('role','option');
      row.setAttribute('aria-selected', selectedFilms.has(f));
      row.htmlFor=id;
      const cb=document.createElement('input');
      cb.type='checkbox'; cb.id=id; cb.checked=selectedFilms.has(f);
      cb.addEventListener('change',()=>{
        if(cb.checked)selectedFilms.add(f);else selectedFilms.delete(f);
        row.setAttribute('aria-selected',cb.checked);renderFilmChips();updateFilmCount();render();
      });
      const txt=document.createElement('span');txt.textContent=f;
      row.append(cb,txt); filmMsList.append(row);
    }
  }
  function renderFilmChips(){
    filmMsChips.innerHTML='';
    for(const f of Array.from(selectedFilms).sort(naturalSort)){
      const chip=document.createElement('span');chip.className='chip';
      chip.innerHTML=`${f} <button>×</button>`;
      chip.querySelector('button').addEventListener('click',()=>{
        selectedFilms.delete(f);renderFilmList();renderFilmChips();updateFilmCount();render();
      });
      filmMsChips.append(chip);
    }
  }
  function openFilmMs(){filmMsPop.hidden=false;filmMsBtn.setAttribute('aria-expanded','true');filmMsSearch.focus();}
  function closeFilmMs(){filmMsPop.hidden=true;filmMsBtn.setAttribute('aria-expanded','false');}
  filmMsBtn.addEventListener('click',()=>filmMsPop.hidden?openFilmMs():closeFilmMs());
  document.addEventListener('click',e=>{if(!filmMs.contains(e.target))closeFilmMs();});
  filmMsSearch.addEventListener('input',()=>{
    const q=norm(filmMsSearch.value);
    filteredFilms=allFilms.filter(s=>norm(s).includes(q));
    renderFilmList();
  });
  filmMsSelectAll.addEventListener('click',()=>{
    for(const f of filteredFilms)selectedFilms.add(f);
    renderFilmList();renderFilmChips();updateFilmCount();render();
  });
  filmMsClear.addEventListener('click',()=>{
    selectedFilms.clear();renderFilmList();renderFilmChips();updateFilmCount();render();
  });
  renderFilmList();updateFilmCount();

  // ----- Sleeves multi-select -----
  const ms=$('#sleevesMs'),msBtn=$('#msBtn'),msPop=$('#msPop'),msSearch=$('#msSearch'),
        msList=$('#msList'),msCount=$('#msCount'),msChips=$('#msChips'),
        msSelectAll=$('#msSelectAll'),msClear=$('#msClear');
  const allSleeves=Array.from(new Set(items.map(i=>i.negative_sleeve).filter(Boolean))).sort(naturalSort);
  const selectedSleeves=new Set(); let filteredSleeves=allSleeves.slice();
  function updateMsCount(){
    if(selectedSleeves.size===0){msCount.textContent='All';return;}
    const first=Array.from(selectedSleeves).sort(naturalSort).slice(0,2).join(', ');
    msCount.textContent=selectedSleeves.size>2?`${first} +${selectedSleeves.size-2}`:first||'All';
  }
  function renderMsList(){
    msList.innerHTML='';
    for(const s of filteredSleeves){
      const id='sleeve_'+btoa(unescape(encodeURIComponent(s))).replace(/=/g,'');
      const row=document.createElement('label');
      row.className='ms__item';row.htmlFor=id;
      const cb=document.createElement('input');
      cb.type='checkbox';cb.id=id;cb.checked=selectedSleeves.has(s);
      cb.addEventListener('change',()=>{
        if(cb.checked)selectedSleeves.add(s);else selectedSleeves.delete(s);
        renderMsChips();updateMsCount();render();
      });
      const txt=document.createElement('span');txt.textContent=s;
      row.append(cb,txt);msList.append(row);
    }
  }
  function renderMsChips(){
    msChips.innerHTML='';
    for(const s of Array.from(selectedSleeves).sort(naturalSort)){
      const chip=document.createElement('span');chip.className='chip';
      chip.innerHTML=`${s} <button>×</button>`;
      chip.querySelector('button').addEventListener('click',()=>{
        selectedSleeves.delete(s);renderMsList();renderMsChips();updateMsCount();render();
      });
      msChips.append(chip);
    }
  }
  function openMs(){msPop.hidden=false;msBtn.setAttribute('aria-expanded','true');msSearch.focus();}
  function closeMs(){msPop.hidden=true;msBtn.setAttribute('aria-expanded','false');}
  msBtn.addEventListener('click',()=>msPop.hidden?openMs():closeMs());
  document.addEventListener('click',e=>{if(!ms.contains(e.target))closeMs();});
  msSearch.addEventListener('input',()=>{
    const q=norm(msSearch.value);
    filteredSleeves=allSleeves.filter(s=>norm(s).includes(q));renderMsList();
  });
  msSelectAll.addEventListener('click',()=>{
    for(const s of filteredSleeves)selectedSleeves.add(s);
    renderMsList();renderMsChips();updateMsCount();render();
  });
  msClear.addEventListener('click',()=>{
    selectedSleeves.clear();renderMsList();renderMsChips();updateMsCount();render();
  });
  renderMsList();updateMsCount();

  // Zoom slider
  function applyZoom(px){document.documentElement.style.setProperty('--card-min',px+'px');}
  applyZoom(zoom.value);
  zoom.addEventListener('input',()=>applyZoom(zoom.value));

  // ----- Main filtering -----
  let showThumbs=true;
  function matches(i){
    if(selectedFilms.size>0&&!selectedFilms.has(i.film||''))return false;
    if(selectedSleeves.size>0&&!selectedSleeves.has(i.negative_sleeve||''))return false;
    return true;
  }
  function sortItems(arr){
    const key=sortKey.value;
    return arr.slice().sort((a,b)=>{
      const A=(a?.[key]??'').toString().toLowerCase();
      const B=(b?.[key]??'').toString().toLowerCase();
      return A<B?-1:A>B?1:0;
    });
  }
  function render(){
    cards.classList.toggle('cards--list',viewMode.value==='list');
    const filtered=sortItems(items.filter(matches));
    cards.innerHTML='';
    for(const i of filtered){
      const card=document.createElement('div');card.className='card';
      const title=i.print_id||i.title||'Untitled';
      const row=document.createElement('div');
      if(viewMode.value==='list')row.className='list-row';
      if(i.thumb_path){
        const img=document.createElement('img');img.className='thumb';
        img.src=i.thumb_path+'?ts='+Date.now();img.alt=title;
        img.style.display=showThumbs?'block':'none';row.append(img);
      }
      const content=document.createElement('div');
      const h=document.createElement('div');h.className='row';h.innerHTML='<strong>'+title+'</strong>';content.append(h);
      const meta=document.createElement('div');
      meta.innerHTML='<div class="row">'+
        (i.print_id?'<span class="pill">PrintID: '+i.print_id+'</span>':'')+
        (i.negative_sleeve?'<span class="pill">Sleeve: '+i.negative_sleeve+'</span>':'')+
        (i.frame_number?'<span class="pill">Frame: '+i.frame_number+'</span>':'')+
        (i.film?'<span class="pill">Film: '+i.film+'</span>':'')+
        '</div>';
      content.append(meta);
      if(i.description){const p=document.createElement('div');p.className='row muted';p.textContent=i.description;content.append(p);}
      if(i.file_path){const link=document.createElement('a');link.href=i.file_path;link.textContent='Local file path';link.target='_blank';content.append(link);}
      row.append(content);card.append(row);cards.append(card);
    }
  }
  viewMode.addEventListener('change',render);
  sortKey.addEventListener('change',render);
  toggleThumbsBtn.addEventListener('click',()=>{
    showThumbs=!showThumbs;
    toggleThumbsBtn.textContent=showThumbs?'Hide thumbnails':'Show thumbnails';
    render();
  });
  render();
})();
</script>
</body>
</html>